<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Prueba con Redux</title>
  <script src="https://unpkg.com/redux@latest/dist/redux.min.js"></script>
  <style>
    table, th, td {
	  border-collapse: collapse;
	  border: 1px solid #000;
	}
    td {
	  text-align: center;
	}
  </style>
</head>
<body>
  <table width="100%">
  <thead>
    <tr> 
	  <th colspan="4">SABER</th>
	  <th colspan="4">HACER</th>
	  <th colspan="4">SER</th>
	  <th rowspan="2">DEF</th>
	</tr>
    <tr>	  
	  <th>S1</th>
	  <th>S2</th>
	  <th>S3</th>
	  <th>DEF</th>
	  <th>H1</th>
	  <th>H2</th>
	  <th>H3</th>
	  <th>DEF</th>
	  <th>S1</th>
	  <th>S2</th>
	  <th>S3</th>
	  <th>DEF</th>
	</tr>
  </thead>
  <tbody>
    <tr id="1000">
	  <td><input type="text" value="" data-saber="1" data-codigo="1000" maxlength="3" size="3" onchange="add(this.value, 'saber', this.dataset)" oninput="validar('saber', this.dataset)"></td>
	  <td><input type="text" value="" data-saber="2" data-codigo="1000" maxlength="3" size="3" onchange="add(this.value, 'saber', this.dataset)" oninput="validar('saber', this.dataset)"></td>
	  <td><input type="text" value="" data-saber="3" data-codigo="1000" maxlength="3" size="3" onchange="add(this.value, 'saber', this.dataset)" oninput="validar('saber', this.dataset)"></td>
	  <td id="def-saber-1000">0</td>
	  <td><input type="text" value="" data-hacer="1" data-codigo="1000" maxlength="3" size="3" onchange="add(this.value, 'hacer', this.dataset)" oninput="validar('hacer', this.dataset)"></td>
	  <td><input type="text" value="" data-hacer="2" data-codigo="1000" maxlength="3" size="3" onchange="add(this.value, 'hacer', this.dataset)" oninput="validar('hacer', this.dataset)"></td>
	  <td><input type="text" value="" data-hacer="3" data-codigo="1000" maxlength="3" size="3" onchange="add(this.value, 'hacer', this.dataset)" oninput="validar('hacer', this.dataset)"></td>
	  <td id="def-hacer-1000">0</td>
	  <td><input type="text" value="" data-ser="1" data-codigo="1000" maxlength="3" size="3" onchange="add(this.value, 'ser', this.dataset)" oninput="validar('ser', this.dataset)"></td>
	  <td><input type="text" value="" data-ser="2" data-codigo="1000" maxlength="3" size="3" onchange="add(this.value, 'ser', this.dataset)" oninput="validar('ser', this.dataset)"></td>
	  <td><input type="text" value="" data-ser="3" data-codigo="1000" maxlength="3" size="3" onchange="add(this.value, 'ser', this.dataset)" oninput="validar('ser', this.dataset)"></td>
	  <td id="def-ser-1000">0</td>
	  <td id="def-1000">0</td>
	</tr>
  </tbody>
  </table>
  <div>
    <button id="guardar">Guardar</button>
  </div>
  <script>
    function reducer(state, action) {
	  if (typeof state === 'undefined') {
	    return {
		  estudiantes: {},
		  curso: '6-1'
		}
	  }
	  switch (action.type) {	    
        case 'ADD_ESTUDIANTE':
		  state.estudiantes[action.codigo] = action.notas;
          return state
		case 'ADD_TODO_ESTUDIANTE':
		  state.estudiantes = action.estudiantes;
          return state
        case 'UPDATE_NOTA_ESTUDIANTE':
          state.estudiantes[action.codigo][action.comp][action.pos] = action.nota
		  return state
		case 'DELETE_NOTA_ESTUDIANTE':
		  delete state.estudiantes[action.codigo][action.comp][action.pos]
		  return state
	    default:
		  return state
	  }
    }
    
	var store = Redux.createStore(reducer)
	
	store.subscribe(() => {
	  console.log(store.getState());
	})	
	
	function init() {
	  /*let estudiantes = {
	    "1000": {saber: {1: 5.0, 2: 3.5, 3: 4.5}, hacer: {1: 3.5, 3: 5.0}, ser: {1: 0}}
	  }	  
	
	  for (codigo in estudiantes) {
	    store.dispatch({ type: 'ADD_ESTUDIANTE', codigo: codigo, notas: estudiantes[codigo] })
		renderEstudiante(codigo)
	  }*/
	  
	  let estudiantes = JSON.parse('{"1000":{"saber":{"1":5,"2":3.5,"3":4.5},"hacer":{"1":3.5,"3":5},"ser":{"1":0}}}')
	  store.dispatch({ type: 'ADD_TODO_ESTUDIANTE', estudiantes: estudiantes })
	  for (codigo in estudiantes) {
	    renderEstudiante(codigo)
	  }
	}
	
	function renderEstudiante(codigo) {
	  let tr = document.getElementById(codigo)
	  let estudiante = store.getState().estudiantes[codigo]
	  if (tr) {
	    if (typeof estudiante !== undefined) {
		  for (comp in estudiante) {
			  for (pos in estudiante[comp]) {
				  let input = tr.querySelector('input[data-' + comp + '="' + pos + '"]')
				  
				  if (input) {
					input.value = estudiante[comp][pos]					
                    def(comp, { codigo: codigo })					
				  }
			  }
		  }
		}
	  }
	}
    
	function add(nota, comp, dataset) {	  
	  let codigo = dataset.codigo
	  let pos = dataset[comp]
	  //let estudiantes = store.getState().estudiantes
	  if (typeof store.getState().estudiantes[codigo][comp][pos] !== undefined && nota == '') {
	    store.dispatch({ type: 'DELETE_NOTA_ESTUDIANTE', codigo: codigo, comp: comp, pos: pos })
	  } else {	    
	    if (nota != '') {
		  store.dispatch({ type: 'UPDATE_NOTA_ESTUDIANTE', codigo: codigo, comp: comp, pos: pos, nota: +nota })
		}
	  }
	  def(comp, dataset)
	}
	
	function validar(comp, dataset) {
	  let codigo = dataset.codigo
	  let pos = dataset[comp]
	  let tr = document.getElementById(codigo)
	  
	  if (tr) {
		  let input = tr.querySelector('input[data-' + comp + '="' + pos + '"]')
		  
		  if (input) {
		    let nota = input.value
			input.value = nota.replace(/[^0-9\.]/g, '')			
		  }
	  }
	}
	
	function def(comp, dataset) {
	  let codigo = dataset.codigo
	  let notaDef = document.getElementById('def-' + comp + '-' + codigo)
      let cant = 0, sum = 0;	  
	  for (pos in store.getState().estudiantes[codigo][comp]) {
	    sum += +store.getState().estudiantes[codigo][comp][pos]
		cant++
	  }
	  if (cant) {
	    notaDef.innerHTML = (sum/cant).toFixed(2)
	  }	  
	}
	
	window.onload = () => {
	  init()
	  
	  let guardar = document.getElementById('guardar')
	  guardar.addEventListener('click', () => {
	    console.log(JSON.stringify(store.getState()))
	  })
	}
  </script>
</body>
</html>